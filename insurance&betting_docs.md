# BettingPool & InsureBets Integrated System Documentation

## 1. System Architecture and Insurance Integration

The BettingPool contract operates as a peer-to-peer betting matching engine with house backup, enhanced by an optional InsureBets layer that provides financial security for users. When users place bets on match outcomes, they simultaneously have the option to insure their wagers by selecting a coverage tier—Gold, Silver, or Bronze—each with predefined premium percentages and payout ratios. The core matching mechanism attempts to pair opposing bets in real-time; if User A bets 100 tokens on Player A and User B bets 100 tokens on Player B, their bets are directly paired with no house involvement. If no direct match is found, the house vault becomes the automatic counterparty. The insurance contract operates independently but communicates with the main betting pool to track insured bets and process claims, ensuring that the main betting liquidity remains unaffected while users receive payouts from dedicated insurance reserves.

## 2. Bet Placement, Matching, and Insurance Coverage

When a user calls `placeBet(matchId, side, amount)` with optional insurance parameters, the contract validates the request by confirming match approval, preventing double-betting on the same match, and enforcing minimum/maximum bet limits. The premium for the selected tier is calculated upfront (e.g., Gold tier = 10% premium with 50% loss payout) and transferred to the insurance pool during bet placement. The matching algorithm then attempts to find counterparties: for full matches, both bets are immediately paired and locked; for partial matches, the system supports flexible 1-to-N scenarios (1-to-2, 1-to-5, 1-to-10 matching ratios). Any unmatched portion defaults to house matching, ensuring continuous liquidity. The BettingPool stores all metadata in mappings indexed by user and match ID, including bet amount, side, timestamp, insured status, tier selected, and premium paid. Insurance metadata is maintained separately in the InsureBets contract for independent claim processing.

## 3. Settlement, Claim Processing, and Payout Distribution

Settlement begins when an oracle or authorized account calls `settleBet(matchId, winner)` with the authenticated match result. The BettingPool contract identifies all bets on that match and determines winners. For peer-to-peer paired bets, winnings are paid directly from the opponent's locked amount—if User A wins, they receive their original stake plus the opponent's stake (2x multiplier). For house-backed bets, payouts are disbursed from the vault. Simultaneously, the InsureBets contract checks each settled bet: if a user lost AND their bet was insured, they become eligible for a claim payout based on their coverage tier. This payout is processed from the insurance pool reserves, independent of the main betting liquidity. The ReentrancyGuard protects all fund transfers against reentrancy attacks. Claim status is updated to prevent duplicate payouts, and bet states transition to "settled" once all distributions are complete. If the vault or insurance pool depletes, liquidity replenishment mechanisms trigger or new bets are paused until reserves are restored.

## 4. Flexible Matching Logic with Tiered Insurance Economics

The system supports multiple matching scenarios while maintaining transparent insurance economics. The flexible bet matching algorithm handles 1-to-1 peer matches, 1-to-N multi-opponent matches, and house fallback matching seamlessly. When a user places an insured bet, the system records which matching type occurred, allowing claims to be processed correctly regardless of whether the user's opponent was a single peer, multiple peers, or the house. Insurance tiers create predictable platform economics: premiums from all insured bets accumulate in the insurance pool, creating reserves that cover claims from losing insured users. This tiered structure allows users to choose coverage based on risk appetite and budget while maintaining platform profitability. For example, a user betting 100 tokens on Gold tier pays 10 tokens premium and receives 50 tokens if they lose (50% loss recovery). Over time, if more users win than lose, the insurance pool accumulates surplus; conversely, if loss rates exceed premium collections, the platform must top up reserves or dynamically adjust tier pricing based on claims history and match volatility.

## 5. Risk Controls, Validation, and System Integrity

Multiple constraints ensure abuse prevention, contract stability, and transparent operations. Minimum and maximum bet amounts prevent spam and catastrophic losses. Time-based checks block bet placement after a match starts—`require(block.timestamp < matchStartTime)`. A mapping `userBetsSidePerMatch[user][matchId]` prevents double-betting on the same match, across both insured and uninsured bets. Only oracle-approved matches stored in an approved registry can receive bets. Users cannot retroactively insure bets—insurance must be selected at placement time. Claims are only processed after oracle verification of match results, preventing false claims. Access control via Ownable restricts settlement, match approval, insurance parameters, and vault management to authorized entities. The insurance pool must maintain sufficient reserves; if reserves drop below a threshold, new insured bets are paused or premium rates adjust dynamically. All state changes emit events for off-chain monitoring and transparency. Emergency pause functionality allows the owner to halt all betting during anomalies. This multi-layered validation creates a resilient system that balances user protection with platform sustainability.